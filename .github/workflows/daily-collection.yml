name: Daily Consultancy News Collection

on:
  schedule:
    # Run daily at 8:00 AM UTC (4:00 AM EST, 9:00 AM CET)
    - cron: '0 8 * * *'
  workflow_dispatch:
    # Allow manual execution

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Run consultancy news collection
      id: collection
      run: |
        echo "ðŸš€ Starting consultancy news collection..."
        
        # Run the collection via API call to Railway deployment
        RAILWAY_URL="${{ secrets.RAILWAY_URL }}"
        
        if [ -n "$RAILWAY_URL" ]; then
          echo "ðŸ“¡ Triggering collection via Railway webhook..."
          
          # Simple curl request without complex parsing
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            "$RAILWAY_URL/webhook/collect" \
            -d '{"source": "github-actions", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}')
          
          echo "Response Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Collection completed successfully via Railway"
            echo "collection_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Collection failed via Railway (Status: $HTTP_STATUS)"
            echo "collection_success=false" >> $GITHUB_OUTPUT
          fi
          
        else
          echo "âš ï¸ RAILWAY_URL not configured, skipping remote collection"
          echo "collection_success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Update workflow summary
      if: always()
      run: |
        echo "## ðŸ“Š Consultancy News Collection Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Project**: Peers Consulting & Technology" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.collection.outputs.collection_success }}" == "true" ]; then
          echo "âœ… **Status**: Collection completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“§ **Email**: Sent to heitor.a.marin@gmail.com" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status**: Collection failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ¢ Monitored Consultancies" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **BIG 4**: Deloitte, PwC, EY, KPMG" >> $GITHUB_STEP_SUMMARY
        echo "- **MBB**: McKinsey, BCG, Bain" >> $GITHUB_STEP_SUMMARY
        echo "- **Global**: Accenture, IBM Consulting, Capgemini" >> $GITHUB_STEP_SUMMARY
        echo "- **Regional**: Oliver Wyman, Roland Berger, A.T. Kearney" >> $GITHUB_STEP_SUMMARY
        
    - name: Send notification on failure
      if: failure()
      run: |
        echo "ðŸš¨ Workflow failed - check logs for details"
        echo "Railway URL configured: ${{ secrets.RAILWAY_URL != '' }}"

